/**
 *
 * Please note:
 * This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * Do not edit this file manually.
 *
 */

@file:Suppress(
    "ArrayInDataClass",
    "EnumEntryName",
    "RemoveRedundantQualifierName",
    "UnusedImport"
)

package com.flagent.client.apis

import io.kotest.matchers.shouldBe
import io.kotest.core.spec.style.ShouldSpec
import io.ktor.client.engine.mock.MockEngine
import io.ktor.client.engine.mock.respond
import io.ktor.http.HttpHeaders
import io.ktor.http.HttpStatusCode
import io.ktor.utils.io.ByteReadChannel
import kotlinx.coroutines.test.runTest
import com.flagent.client.models.CreateFlagRequest
import com.flagent.client.models.PutFlagRequest
import com.flagent.client.models.SetFlagEnabledRequest

class FlagApiTest : ShouldSpec() {
    private val flagJson = """{"id":1,"key":"test_flag","description":"Desc","enabled":true,"dataRecordsEnabled":false}"""
    private val flagListJson = """[$flagJson]"""
    private val snapshotListJson = """[{"id":1,"flag":$flagJson,"updatedAt":"2024-01-01T00:00:00Z","updatedBy":"system"}]"""
    private val entityTypesJson = """["user","device"]"""

    init {
        should("test createFlag") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val req = CreateFlagRequest(description = "New flag", key = "new_feature")
                val response = api.createFlag(req)
                response.status shouldBe 200
                val body = response.body()
                body.key shouldBe "test_flag"
                body.enabled shouldBe true
            }
        }

        should("test deleteFlag") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel("{}"), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                api.deleteFlag(789L)
            }
        }

        should("test findFlags") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagListJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val response = api.findFlags(limit = 10L, offset = 0L, null, null, null, null, null, null, null)
                response.status shouldBe 200
                val body = response.body()
                body.size shouldBe 1
                body[0].key shouldBe "test_flag"
            }
        }

        should("test getFlag") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val response = api.getFlag(789L)
                response.status shouldBe 200
                response.body().key shouldBe "test_flag"
            }
        }

        should("test getFlag with bearer auth applied") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                api.setBearerToken("test-token")
                val response = api.getFlag(789L)
                response.status shouldBe 200
                response.body().key shouldBe "test_flag"
            }
        }

        should("test getFlag with basic auth applied") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                api.setUsername("user")
                api.setPassword("pass")
                val response = api.getFlag(789L)
                response.status shouldBe 200
                response.body().key shouldBe "test_flag"
            }
        }

        should("test getFlagEntityTypes") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(entityTypesJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val response = api.getFlagEntityTypes()
                response.status shouldBe 200
                val body = response.body()
                body shouldBe listOf("user", "device")
            }
        }

        should("test getFlagSnapshots") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(snapshotListJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val response = api.getFlagSnapshots(789L, 10L, 0L, null)
                response.status shouldBe 200
                val body = response.body()
                body.size shouldBe 1
                body[0].flag.key shouldBe "test_flag"
            }
        }

        should("test putFlag") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val req = PutFlagRequest(description = "Updated")
                val response = api.putFlag(789L, req)
                response.status shouldBe 200
                response.body().key shouldBe "test_flag"
            }
        }

        should("test restoreFlag") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val response = api.restoreFlag(789L)
                response.status shouldBe 200
                response.body().id shouldBe 1L
            }
        }

        should("test setFlagEnabled") {
            runTest {
                val mockEngine = MockEngine {
                    respond(ByteReadChannel(flagJson), HttpStatusCode.OK, io.ktor.http.headersOf(HttpHeaders.ContentType, "application/json"))
                }
                val api = FlagApi(baseUrl = "http://localhost", httpClientEngine = mockEngine)
                val response = api.setFlagEnabled(789L, SetFlagEnabledRequest(enabled = true))
                response.status shouldBe 200
                response.body().enabled shouldBe true
            }
        }
    }
}
