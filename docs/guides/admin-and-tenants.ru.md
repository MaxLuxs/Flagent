# Админ и тенанты: кто есть кто и как с этим работать

В этом руководстве объясняется разница между **админом** и **тенантом** во Flagent, почему интерфейс просит «выбрать тенанта» даже когда вы админ, и как с этим работать.

---

## Что такое тенант (tenant)?

**Тенант** — это **клиент или рабочее пространство**: один изолированный набор данных (флаги, сегменты, варианты, эксперименты, метрики). Можно думать о нём как об «одной компании» или «одном проекте» в мультитенантной схеме.

- **Изоляция данных** — Тенант A не видит и не меняет флаги тенанта B. У каждого тенанта своя схема (или свои таблицы с tenant_id) в БД.
- **API-ключ** — У каждого тенанта есть один или несколько API-ключей. Мобильное приложение, бэкенд или SDK передают заголовок `X-API-Key: <ключ-тенанта>`, чтобы сервер понимал, чьи данные читать/писать.
- **Учёт и биллинг** — Оценки флагов, вызовы API и отчёты об ошибках считаются по тенанту (лимиты и биллинг в SaaS).

Итого: **тенант = чьи данные мы обрабатываем**. Любой запрос к флагам/сегментам/экспериментам должен однозначно определять тенанта — это и даёт API-ключ (или JWT с уже прописанным `tenant_id`).

---

## Кто такой админ?

**Админ** — это **оператор платформы**: тот, кто управляет экземпляром Flagent (или SaaS-платформой). Админ в интерфейсе **не** означает «вижу и делаю всё во всех тенантах».

- **Админ может:**
  - Входить в **админ-интерфейс** (email/пароль или SSO, в зависимости от настройки).
  - Создавать и просматривать **тенантов** (`POST /admin/tenants`, `GET /admin/tenants`).
  - Управлять биллингом, SSO, умным раскатом, настройками аномалий (enterprise).
  - Обращаться к **админским маршрутам**, защищённым `X-Admin-Key` или JWT с `admin: true`.

- **Админ по умолчанию не получает:**
  - Доступ к данным тенанта (флаги, сегменты и т.д.) **без контекста тенанта**. API, которые отдают флаги (`/api/v1/flags`, статистика дашборда и т.п.), **привязаны к тенанту**. Серверу нужно знать, *для какого* тенанта отвечать; это задаётся заголовком `X-API-Key` или JWT с полем `tenant_id` (например, у пользователей, залогиненных по SSO в этот тенант).

Итого: **админ = тот, кто может управлять платформой и создавать тенантов**. Это не «я админ — значит вижу данные всех тенантов в одном экране». Интерфейс устроен так, что в каждый момент вы работаете **в рамках одного тенанта** (того, чей API-ключ подставлен в запросы).

---

## Почему интерфейс просит выбрать тенанта, если я уже админ?

Потому что **интерфейс привязан к одному тенанту**:

1. Когда вы открываете Dashboard, Флаги, Эксперименты и т.д., фронтенд дергает API вроде `/api/v1/flags`, `/api/v1/stats` и т.п.
2. Этим API нужен **контекст тенанта**: они должны понимать, флаги и статистику *какого* тенанта возвращать.
3. Контекст тенанта определяется:
   - **`X-API-Key`** — API-ключ тенанта (его браузер хранит после создания тенанта или нажатия «Использовать» у тенанта, созданного в этом браузере), или
   - **Bearer JWT с `tenant_id`** — когда пользователь зашёл через **SSO в конкретный тенант** (тогда в JWT уже указано, к какому тенанту он привязан).

Когда вы логинитесь как **админ** (email/пароль), вы получаете JWT с признаком «этот пользователь — админ». В нём **нет** `tenant_id`, потому что админ — глобальная роль, не привязанная к одному тенанту. Поэтому сервер не может сам решить, «данные какого тенанта показывать». Интерфейсу нужен API-ключ (или аналог), который будет отправляться с каждым запросом — а ключ привязан к **одному** тенанту. Поэтому нужно либо:

- **Создать тенанта** (вы получите его API-ключ, интерфейс его сохранит), либо  
- **Выбрать существующего тенанта**, для которого в этом браузере уже сохранён API-ключ (например, вы его здесь создавали).

То есть просьба «выбрать или создать тенанта» — не ограничение прав админа, а ответ на вопрос: **в контексте какого тенанта** должен работать интерфейс сейчас?

---

## Как с этим работать на практике

### Один тенант (одна компания, один экземпляр Flagent)

1. Войти как админ.
2. Создать **одного** тенанта (например, «Моя компания») — вы получите его API-ключ.
3. Интерфейс сохранит этот ключ и будет подставлять его во все запросы. Вы работаете только в этом тенанте.
4. Ваши приложения/SDK используют тот же API-ключ в `X-API-Key` для оценок флагов.

Переключать тенантов не нужно, пока не появятся новые.

### Несколько тенантов (SaaS: много клиентов)

1. Войти как админ.
2. Создавать по тенанту на клиента (например, «Acme», «Beta Inc»). У каждого свой API-ключ.
3. В админ-интерфейсе **переключать** тенанта: нажать «Использовать» у того, чей API-ключ уже сохранён в этом браузере (обычно только что созданный или уже использованный). Дальше интерфейс отправляет ключ этого тенанта с каждым запросом.
4. Конечные пользователи клиента могут входить через **SSO** в *свой* тенант; в их JWT уже есть `tenant_id`, поэтому им не нужно выбирать тенанта — они уже в контексте своего тенанта.

Итого:

- **Админ** = роль на уровне платформы (создавать тенантов, управлять биллингом и т.д.).
- **Тенант** = область данных (чьи флаги/эксперименты мы видим и редактируем).
- **Выбор тенанта в UI** = выбор, какой API-ключ подставлять, чтобы интерфейс загружал данные этого тенанта.

---

## API-ключ: сохранить один раз, использовать везде

Во Flagent используется тот же подход **«показать один раз»**, что и у Stripe, AWS и других платформ: API-ключ тенанта показывается **только один раз** при создании тенанта. После этого его нельзя посмотреть в интерфейсе снова (только выдать новый или создать дополнительный ключ, в зависимости от продукта).

### Когда вы создаёте тенанта

1. **Сразу после создания** отображается шаг с вашим API-ключом и кнопкой **Копировать**.
2. **Сразу сохраните ключ** в менеджер паролей, файл `.env` или в защищённые заметки. Он нужен для:
   - **SDK и приложения** — задайте заголовок `X-API-Key` в бэкенде, мобильном или веб-приложении, чтобы запросы шли в контексте этого тенанта.
   - **Другого браузера или устройства** — на странице «Тенанты» используйте блок **«Войти по API-ключу с другого устройства»**, вставьте ключ и продолжите. Ключ сохранится в этом браузере для выбранного тенанта.
3. В интерфейсе есть напоминание: *«Сохраните API-ключ сейчас — позже он не будет показан снова.»* Краткая подсказка объясняет, что ключ используется в приложении (X-API-Key) или на странице «Тенанты» в другом браузере.

### Если ключ не сохранили

- **В том же браузере:** Ключ уже сохранён для только что созданного тенанта, можно продолжать работу. Скопировать его потом можно при необходимости (например, из DevTools → Application → Local Storage → `api_key`). Лучше не полагаться на это и сохранить ключ при создании.
- **В другом браузере или на новом устройстве:** Нужен ключ, сохранённый при создании (от коллеги, из менеджера паролей или env). Вставьте его в блок «Войти по API-ключу с другого устройства» на странице «Тенанты».
- **Ключ потерян (нигде нет копии):** **Тот же** ключ восстановить нельзя — в базе хранится только его хэш. Можно получить **новый** ключ:
  - **Админ / саппорт:** Создать новый API-ключ для тенанта через **POST /admin/tenants/{tenantId}/api-keys** (Enterprise). Тело: `{ "name": "Recovery", "scopes": [] }` (пустой `scopes` = полные права по умолчанию). В ответе новый ключ приходит **один раз**; передайте его пользователю по защищённому каналу (менеджер паролей, защищённая ссылка). Пользователь вставляет ключ в «Войти по API-ключу с другого устройства» или в конфиг SDK.
  - **Если есть ещё один рабочий ключ или SSO:** В контексте этого тенанта можно создать дополнительные ключи через **POST /tenants/me/api-keys** (например, из настроек или API). Восстановление через админа нужно только когда **все** ключи потеряны.

### Как делают в крупных продуктах

- **Показать один раз** — ключ показывается только при создании, с явным предупреждением скопировать его.
- **Кнопка «Копировать»** — один клик копирует ключ в буфер обмена; сохраните его в надёжном месте.
- **Не коммитить ключи** — храните их в переменных окружения, секрет-менеджерах или CI secrets, не в коде.
- **Отдельные ключи на окружения** — используйте разные ключи для dev/staging/prod, если продукт это поддерживает.

---

## Кратко

| Понятие | Смысл |
|--------|--------|
| **Тенант** | Один клиент/рабочее пространство: изолированные флаги, сегменты, API-ключи, учёт использования. |
| **Админ** | Оператор платформы: может создавать тенантов и вызывать админские API; при этом в UI у него нет «одного ключа на все тенанты». |
| **Зачем выбирать тенанта?** | Приложение и API завязаны на тенанта; серверу нужен API-ключ (или JWT с `tenant_id`), чтобы вернуть данные нужного тенанта. |
| **Как «увидеть» тенанта** | Создать его (получите API-ключ) или нажать «Использовать» у тенанта, созданного в этом браузере; дальше интерфейс будет использовать этот ключ во всех запросах. |

После того как у вас есть один тенант и его API-ключ сохранён в браузере, вы работаете как админ **внутри этого тенанта**, пока не переключитесь на другого (если их несколько и их ключи тоже сохранены).
