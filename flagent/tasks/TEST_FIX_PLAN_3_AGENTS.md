# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∞–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (3 –∞–≥–µ–Ω—Ç–∞)

## –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–í—Å–µ–≥–æ –ø–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤**: ~26 —Ç–µ—Å—Ç–æ–≤
- **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º**:
  1. EvalCache —Ç–µ—Å—Ç—ã - 9 —Ç–µ—Å—Ç–æ–≤
  2. AuthMiddleware —Ç–µ—Å—Ç—ã - 6 —Ç–µ—Å—Ç–æ–≤  
  3. SubjectTest —Ç–µ—Å—Ç—ã - 5 —Ç–µ—Å—Ç–æ–≤
  4. EvaluateBatchUseCase —Ç–µ—Å—Ç—ã - 3 —Ç–µ—Å—Ç–∞
  5. ErrorHandling —Ç–µ—Å—Ç—ã - 2 —Ç–µ—Å—Ç–∞
  6. VariantSelector —Ç–µ—Å—Ç - 1 —Ç–µ—Å—Ç

---

## üîµ –ê–ì–ï–ù–¢ 1: Domain/UseCase & Error Handling

### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–æ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.

### –ó–∞–¥–∞—á–∏

#### 1. VariantSelectorTest (1 —Ç–µ—Å—Ç)
- **–§–∞–π–ª**: `flagent/backend/src/test/kotlin/flagent/domain/util/VariantSelectorTest.kt`
- **–¢–µ—Å—Ç**: `selectVariant returns null for rollout percent less than 0`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ—Å—Ç –æ–∂–∏–¥–∞–µ—Ç null –ø—Ä–∏ rollout < 0, –Ω–æ —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `VariantSelector.selectVariant()`
  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ rolloutPercent < 0
  3. –õ–∏–±–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –ª–∏–±–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è)
  4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö rollout –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è null

#### 2. EvaluateBatchUseCaseTest (3 —Ç–µ—Å—Ç–∞)
- **–§–∞–π–ª**: `flagent/backend/src/test/kotlin/flagent/domain/usecase/EvaluateBatchUseCaseTest.kt`
- **–ü–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã**:
  - `testInvoke_ReturnsResults_WhenMultipleFlagsProvided`
  - `testInvoke_HandlesDisabledFlags`
  - `testInvoke_HandlesFlagsWithNoSegments`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º `EvaluateFlagUseCase` –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∫–∏ –≤ —Ç–µ—Å—Ç–∞—Ö - –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `relaxed = true` –∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `coEvery`
  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –º–æ–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –Ω—É–∂–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `EvaluateFlagUseCase`
  4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∞—Å—Å–µ—Ä—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

#### 3. ErrorHandlingTest (2 —Ç–µ—Å—Ç–∞)
- **–§–∞–π–ª**: `flagent/backend/src/test/kotlin/flagent/middleware/ErrorHandlingTest.kt`
- **–ü–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã**:
  - `testIllegalArgumentExceptionHandling`
  - `testGenericExceptionHandling`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –í–æ–∑–º–æ–∂–Ω–æ middleware `configureErrorHandling()` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `ErrorHandling.kt` middleware
  2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `StatusPages` plugin –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `IllegalArgumentException` –º–∞–ø–∏—Ç—Å—è –≤ `400 BadRequest`
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `RuntimeException` –º–∞–ø–∏—Ç—Å—è –≤ `500 InternalServerError`
  5. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ middleware –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ –í—Å–µ 6 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö
- ‚úÖ –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞

### –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- VariantSelectorTest: 30 –º–∏–Ω—É—Ç
- EvaluateBatchUseCaseTest: 1-2 —á–∞—Å–∞
- ErrorHandlingTest: 1-2 —á–∞—Å–∞
- **–ò—Ç–æ–≥–æ**: ~3-4 —á–∞—Å–∞

---

## üü¢ –ê–ì–ï–ù–¢ 2: Cache Layer

### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∫—ç—à–∞ (EvalCache).

### –ó–∞–¥–∞—á–∏

#### 1. EvalCacheTest (9 —Ç–µ—Å—Ç–æ–≤)
- **–§–∞–π–ª**: `flagent/backend/src/test/kotlin/flagent/cache/impl/EvalCacheTest.kt`
- **–ü–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã**:
  - `getByFlagKeyOrID returns flag by ID`
  - `getByFlagKeyOrID returns flag by key`
  - `getByFlagKeyOrID returns null for non-existent flag`
  - `getByTags returns flags by tags with ANY operator`
  - `getByTags returns flags by tags with ALL operator`
  - `getByTags excludes disabled flags`
  - `getByTags returns empty list when no flags match`
  - `export returns all cached flags`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º—ã —Å:
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∫—ç—à–∞ (`cache.start()`)
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫—ç—à–∞ (`cache.refresh()`)
  - –ü–æ–∏—Å–∫–æ–º –ø–æ –∫–ª—é—á—É/ID
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ç–µ–≥–∞–º
  - –≠–∫—Å–ø–æ—Ä—Ç–æ–º –¥–∞–Ω–Ω—ã—Ö

- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `EvalCache.kt`
  2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `cache.start()` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫—ç—à
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `refresh()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞ –ø–æ `flagID` –∏ `flagKey` –≤ –º–µ—Ç–æ–¥–µ `getByFlagKeyOrID()`
  5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–µ–≥–∞–º –≤ –º–µ—Ç–æ–¥–µ `getByTags()`:
     - ANY operator - —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–≥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
     - ALL operator - –≤—Å–µ —Ç–µ–≥–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å
  6. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ disabled —Ñ–ª–∞–≥–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç–æ–¥ `export()` - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤—Å–µ —Ñ–ª–∞–≥–∏ –∏–∑ –∫—ç—à–∞
  8. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `cache.refresh()` –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ –í—Å–µ 9 —Ç–µ—Å—Ç–æ–≤ EvalCache –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –ö—ç—à –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- ‚úÖ –ü–æ–∏—Å–∫ –ø–æ ID/–∫–ª—é—á—É —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–≥–∞–º —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ Disabled —Ñ–ª–∞–≥–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è

### –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º: 1 —á–∞—Å
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –ø–æ ID/Key: 1-2 —á–∞—Å–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–µ–≥–∞–º: 2-3 —á–∞—Å–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ export –∏ –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤: 1 —á–∞—Å
- **–ò—Ç–æ–≥–æ**: ~5-7 —á–∞—Å–æ–≤

---

## üü° –ê–ì–ï–ù–¢ 3: Authentication & Subject

### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (AuthMiddleware + Subject).

### –ó–∞–¥–∞—á–∏

#### 1. AuthMiddlewareTest (6 —Ç–µ—Å—Ç–æ–≤)
- **–§–∞–π–ª**: `flagent/backend/src/test/kotlin/flagent/middleware/AuthMiddlewareTest.kt`
- **–ü–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã**:
  - `testCookieAuthDisabled`
  - `testCookieAuthWithPlainCookieValue`
  - `testCookieAuthWithJWTToken`
  - `testCookieAuthWithInvalidJWTToken`
  - `testCookieAuthWithJWTWithoutSecret`
  - `testCookieAuthWithoutCookie`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç cookie authentication, –Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ:
  - Middleware –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ —Ç–µ—Å—Ç–∞—Ö
  - –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `AppConfig.cookieAuthEnabled`
  - JWT —Ç–æ–∫–µ–Ω—ã –Ω–µ –¥–µ–∫–æ–¥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `AuthMiddleware.kt` –∏ –º–µ—Ç–æ–¥ `configureCookieAuth()`
  2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç `AppConfig` –¥–ª—è cookie auth
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ JWT —Ç–æ–∫–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–µ–∫–æ–¥–∏—Ä—É—é—Ç—Å—è –∏–∑ cookie `CF_Authorization`
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `cookieAuthUserFieldJWTClaim` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è user claim
  5. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ `cookieAuthEnabled = false` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 401
  6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö JWT —Ç–æ–∫–µ–Ω–æ–≤
  7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö cookie
  8. –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `testApplication { }` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### 2. SubjectTest (5 —Ç–µ—Å—Ç–æ–≤)
- **–§–∞–π–ª**: `flagent/backend/src/test/kotlin/flagent/util/SubjectTest.kt`
- **–ü–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã**:
  - `testGetSubjectFromHeader`
  - `testGetSubjectFromCookie`
  - `testGetSubjectFromCookieWithoutJWT`
  - `testGetSubjectReturnsEmptyStringWhenNoAuth`
  - `testGetSubjectFromJWTWithMissingClaim`
- **–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü–∏—è `call.getSubject()` –≤–æ–∑–º–æ–∂–Ω–æ:
  - –ù–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç subject –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  - –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é `AppConfig` (headerAuthEnabled, cookieAuthEnabled, jwtAuthEnabled)
  - –ù–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã –≤ cookie
  - –ù–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

- **–î–µ–π—Å—Ç–≤–∏—è**:
  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é extension —Ñ—É–Ω–∫—Ü–∏–∏ `ApplicationCall.getSubject()` –≤ `Subject.kt`
  2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:
     - JWT –∏–∑ Authorization header
     - Subject –∏–∑ header (X-Email)
     - JWT –∏–∑ cookie (CF_Authorization)
     - Plain cookie value
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
     - `AppConfig.jwtAuthEnabled`
     - `AppConfig.headerAuthEnabled`
     - `AppConfig.cookieAuthEnabled`
     - `AppConfig.headerAuthUserField`
     - `AppConfig.cookieAuthUserFieldJWTClaim`
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `null` –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
  5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ JWT –∏–∑ cookie
  6. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –º–æ–∫–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞
- ‚úÖ –í—Å–µ 6 —Ç–µ—Å—Ç–æ–≤ AuthMiddleware –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ –í—Å–µ 5 —Ç–µ—Å—Ç–æ–≤ SubjectTest –ø—Ä–æ—Ö–æ–¥—è—Ç
- ‚úÖ Cookie authentication —Ä–∞–±–æ—Ç–∞–µ—Ç —Å JWT –∏ plain –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–µ–∫–æ–¥–∏—Ä—É—é—Ç—Å—è –∏–∑ cookie
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è

### –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
- –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º: 1-2 —á–∞—Å–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AuthMiddleware: 2-3 —á–∞—Å–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Subject.kt: 2-3 —á–∞—Å–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤: 1-2 —á–∞—Å–∞
- **–ò—Ç–æ–≥–æ**: ~6-10 —á–∞—Å–æ–≤

---

## üìã –û–±—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–≤—Å–µ –∞–≥–µ–Ω—Ç—ã)
1. –°–æ–∑–¥–∞—Ç—å –≤–µ—Ç–∫—É –æ—Ç main: `fix/failing-tests-agent-[1|2|3]`
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∏ –∑–∞–ø–∏—Å–∞—Ç—å —Ç–æ—á–Ω—ã–µ –æ—à–∏–±–∫–∏: `./gradlew :backend:test --no-daemon 2>&1 | tee test-failures.log`
3. –ò–∑—É—á–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### –≠—Ç–∞–ø 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
- –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥ —Å–≤–æ–µ–π —á–∞—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –†–µ–≥—É–ª—è—Ä–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã: `./gradlew :backend:test --tests "*[TestName]*" --no-daemon`
- –ö–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
1. –°–æ–∑–¥–∞—Ç—å PR –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ —Å–ª–æ–º–∞–Ω—ã –¥—Ä—É–≥–∏–µ —Ç–µ—Å—Ç—ã
4. Code review –∏ merge

### –≠—Ç–∞–ø 4: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
1. –ü–æ—Å–ª–µ merge –≤—Å–µ—Ö PR - –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã: `./gradlew :backend:test --no-daemon`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ –Ω–µ —É—Ö—É–¥—à–∏–ª–æ—Å—å
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π

---

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–∞ 1
./gradlew :backend:test --tests "*VariantSelectorTest*" --tests "*EvaluateBatchUseCaseTest*" --tests "*ErrorHandlingTest*" --no-daemon

# –í—Å–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–∞ 2
./gradlew :backend:test --tests "*EvalCacheTest*" --no-daemon

# –í—Å–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–∞ 3
./gradlew :backend:test --tests "*AuthMiddlewareTest*" --tests "*SubjectTest*" --no-daemon
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
```bash
./gradlew :backend:test --tests "*TestName*" --no-daemon --info | grep -A 10 "FAILED"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
```bash
./gradlew :backend:test jacocoTestReport --no-daemon
# –û—Ç—á–µ—Ç: flagent/backend/build/reports/jacoco/test/html/index.html
```

---

## üìù –ó–∞–º–µ—Ç–∫–∏

- **–í–∞–∂–Ω–æ**: –ù–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã
- **–í–∞–∂–Ω–æ**: –°–ª–µ–¥–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞ (Clean Architecture)
- **–í–∞–∂–Ω–æ**: –ü–∏—Å–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –æ–±—Å—É–¥–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MockK –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è –º–æ–∫–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- –î–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TestContainers –∏–ª–∏ in-memory –ë–î

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–∞–±–æ—Ç:
- ‚úÖ –í—Å–µ ~26 –ø–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 80%
- ‚úÖ –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–∞—Ö
- ‚úÖ –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ø—Ä–æ–µ–∫—Ç–∞